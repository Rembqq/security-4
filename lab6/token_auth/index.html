<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login / Register</title>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<style>
    body { 
        font-family: Arial, Helvetica, sans-serif; 
        display: grid; 
        justify-items: center; 
        align-items: center; 
        height: 100vh; 
        margin:0; 
        background-color:#3a3a3a; 
    }
    #main-holder { 
        width: 50%; 
        background:white; 
        padding:40px 20px; 
        border-radius:7px; 
        box-shadow:0 0 5px 2px black; 
        display:grid; 
        justify-items:center; 
        align-items:center; 
        gap: 25px; 
    }
    form { width: 60%; display:grid; justify-items:center; align-items:center; gap: 10px; }
    input { width:100%; padding:8px; margin:0; border:none; border-bottom:1px solid #3a3a3a; border-radius:3px; outline:none; box-sizing:border-box; }
    input::placeholder { color:#3a3a3a; }
    button, input[type=submit] { width:100%; padding:10px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; margin-top: 8px; }
    input[type=submit] { background:#3a3a3a; color:white; }
    button { background:transparent; color:#3a3a3a; text-decoration:underline; }
    #login-error-msg, #register-error-msg { width:60%; text-align:center; margin:10px 0 0; padding:5px; font-size:12px; font-weight:bold; color:#8a0000; border:1px solid #8a0000; background:#e58f8f; opacity:0; }
    #register-box { display:none; width:80%; margin-top:10px; justify-items:center; align-items:start; gap: 10px; }

  
    #logout-btn {
        width: 60%;
        padding: 14px;
        background-color: #dc3545;
        color: white;
        font-weight: bold;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        display: none; /* спочатку прихована */
    }
    #logout-btn:hover {
        background-color: #c82333;
    }

    .btn-sso {
        width: 100%;
        padding: 12px;
        background: #EB5424;
        color: white;
        font-weight: bold;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        text-align: center;
    }
    .btn-sso:hover { background: #d94a1f; }

    .or-separator {
        margin: 20px 0;
        font-size: 14px;
        color: #666;
        position: relative;
        text-align: center;
    }
    .or-separator::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: #ccc;
        z-index: 0;
    }
    .or-separator span {
        background: white;
        padding: 0 10px;
        z-index: 1;
    }
</style>
</head>
<body>
<main id="main-holder">
    
    <button id="logout-btn">Вийти з облікового запису</button>

    <h1 id="login-header">Login</h1>

    
    <a href="/api/login" class="btn-sso">Увійти через Auth0</a>

    <div class="or-separator"><span>або</span></div>

    <div id="login-error-msg-holder">
        <p id="login-error-msg">Invalid username <span id="error-msg-second-line">and/or password</span></p>
    </div>

    <form id="login-form">
        <input type="text" name="login" id="username-field" placeholder="Username or email">
        <input type="password" name="password" id="password-field" placeholder="Password">
        <input type="submit" value="Login" id="login-form-submit">
        <button type="button" id="show-register">Register</button>
    </form>

    <div id="register-box">
        <h2 id="register-header">Register</h2>
        <div id="register-error-msg-holder">
            <p id="register-error-msg">Registration failed</p>
        </div>
        <form id="register-form">
            <input type="email" name="email" id="reg-email-field" placeholder="Email">
            <input type="password" name="password" id="reg-password-field" placeholder="Password">
            <input type="submit" value="Create account" id="register-form-submit">
            <button type="button" id="cancel-register">Cancel</button>
        </form>
    </div>
</main>

<script>
const logoutBtn = document.getElementById("logout-btn");
const loginForm = document.getElementById("login-form");
const loginButton = document.getElementById("login-form-submit");
const loginErrorMsg = document.getElementById("login-error-msg");
const showRegisterBtn = document.getElementById("show-register");
const registerBox = document.getElementById("register-box");
const cancelRegisterBtn = document.getElementById("cancel-register");
const registerForm = document.getElementById("register-form");
const registerErrorMsg = document.getElementById("register-error-msg");
const loginHeader = document.getElementById("login-header");

let token = null;

// Перевірка сесії
const session = sessionStorage.getItem('session');
if (session) {
    try { token = JSON.parse(session).token; } catch(e) {}
}

if (window.location.hash) {
    const params = new URLSearchParams(window.location.hash.substring(1));
    const id_token = params.get('id_token');
    if (id_token) {
        token = id_token;
        sessionStorage.setItem('session', JSON.stringify({
            token: id_token,
            access_token: params.get('access_token'),
            refresh_token: params.get('refresh_token')
        }));
        history.replaceState(null, '', window.location.pathname);
    }
}

if (token) {
    axios.get('/', { headers: { Authorization: `Bearer ${token}` } })
        .then(res => {
            if (res.data.success && res.data.username) {
                
                loginForm.remove();
                document.querySelector('.or-separator')?.remove();
                document.querySelector('.btn-sso')?.remove();
                document.getElementById('login-error-msg-holder')?.remove();
                loginHeader.remove();
                registerBox.remove();
                if (showRegisterBtn) showRegisterBtn.remove();

                
                const hello = document.createElement('div');
                hello.innerHTML = `<strong style="font-size:28px;">Вітаємо, ${res.data.username}!</strong><br><span style="font-size:16px; color:#555;">Ви успішно увійшли в систему</span>`;
                hello.style.textAlign = 'center';
                document.getElementById("main-holder").insertBefore(hello, logoutBtn);

                
                logoutBtn.style.display = 'block';
            }
        })
        .catch(() => {
            sessionStorage.removeItem('session');
        });
}


logoutBtn.addEventListener("click", () => {
    sessionStorage.removeItem('session');
    window.location.href = '/logout'; 
});

loginButton.addEventListener("click", e => {
    e.preventDefault();
    const login = loginForm.login.value;
    const password = loginForm.password.value;
    loginErrorMsg.style.opacity = 0;

    axios.post('/api/login', { login, password })
        .then(res => {
            sessionStorage.setItem('session', JSON.stringify(res.data));
            location.reload();
        })
        .catch(() => {
            loginErrorMsg.style.opacity = 1;
        });
});


showRegisterBtn.addEventListener("click", () => {
    registerBox.style.display = 'grid';
    loginHeader.style.display = 'none';
    loginForm.style.display = 'none';
});

cancelRegisterBtn.addEventListener("click", () => {
    registerBox.style.display = 'none';
    loginHeader.style.display = '';
    loginForm.style.display = '';
    registerErrorMsg.style.opacity = 0;
});

registerForm.addEventListener("submit", e => {
    e.preventDefault();
    const email = document.getElementById('reg-email-field').value;
    const password = document.getElementById('reg-password-field').value;
    registerErrorMsg.style.opacity = 0;

    axios.post('/api/signup', { email, password })
        .then(() => axios.post('/api/login', { login: email, password }))
        .then(loginResp => {
            sessionStorage.setItem('session', JSON.stringify(loginResp.data));
            location.reload();
        })
        .catch(err => {
            registerErrorMsg.textContent = err?.response?.data?.error || 'Registration failed';
            registerErrorMsg.style.opacity = 1;
        });
});
</script>
</body>
</html>